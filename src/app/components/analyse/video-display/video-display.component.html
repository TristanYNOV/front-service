<section
  #hotkeysZone
  tabindex="0"
  class="flex h-full w-full flex-col gap-3 rounded-md bg-slate-950 p-3 text-sm text-slate-100 outline-none focus:ring-2 focus:ring-sky-400/70"
  (keydown)="onKeydown($event)"
  (click)="focusHotkeys()"
  (focusin)="enableHotkeys()"
  (focusout)="disableHotkeys()"
>
  <div class="flex flex-wrap items-center justify-between gap-3">
    <div class="flex flex-wrap items-center gap-3">
      <p class="text-base font-semibold">
        {{ analysisNameService.analysisName() }}
      </p>
      <button type="button" class="btn-secondary text-xs" (click)="startEditingTitle()">Éditer</button>
    </div>
    <p class="text-xs text-slate-400">
      {{ videoName() ?? 'Aucune vidéo chargée' }}
    </p>
  </div>

  @if (isEditingTitle()) {
    <div class="flex flex-wrap items-center gap-2">
      <input
        type="text"
        class="min-w-[180px] flex-1 rounded-md border border-slate-700 bg-slate-900 px-2 py-1 text-sm text-slate-100"
        [value]="titleInput()"
        (input)="onTitleInput($event)"
        placeholder="Nom de l'analyse"
      />
      <button type="button" class="btn-primary text-xs" (click)="saveTitle()">Enregistrer</button>
      <button type="button" class="btn-secondary text-xs" (click)="cancelEditingTitle()">Annuler</button>
    </div>
  }

  <div class="flex min-h-[180px] flex-1 flex-col gap-3">
    <div class="relative flex flex-1 items-center justify-center rounded-md bg-black">
      <video
        #videoElement
        class="absolute inset-0 h-full w-full rounded-md object-contain"
        playsinline
        (loadedmetadata)="onVideoLoaded()"
        (error)="onVideoError()"
      >
        Votre navigateur ne supporte pas la lecture vidéo.
      </video>

      @if (errorMessage()) {
        <div class="absolute inset-0 flex flex-col items-center justify-center gap-3 bg-black/80 p-4 text-center">
          <p class="text-sm text-rose-200">{{ errorMessage() }}</p>
          <button type="button" class="btn-primary" (click)="onChangeVideoClick()">
            Choisir une autre vidéo
          </button>
        </div>
      } @else if (!hasVideo()) {
        <div class="absolute inset-0 flex flex-col items-center justify-center gap-3 text-center text-slate-300">
          <p>Importez une vidéo locale pour démarrer.</p>
        </div>
      }
    </div>

    <div class="flex flex-col gap-3">
      <div class="flex items-center gap-3 text-xs text-slate-300">
        <span class="w-12 text-left text-slate-200">{{ formatDuration(videoService.positionMs()) }}</span>
        <input
          type="range"
          class="flex-1 accent-sky-400"
          min="0"
          [max]="videoService.durationMs() || 0"
          [value]="videoService.positionMs()"
          [disabled]="!hasVideo()"
          (input)="onScrub($event)"
        />
        <span class="w-12 text-right text-slate-200">{{ formatDuration(videoService.durationMs()) }}</span>
      </div>

      <div class="flex flex-wrap items-center gap-3">
      @if (!hasVideo()) {
        <input
          #fileInput
          type="file"
          accept="video/*"
          class="w-full text-xs text-slate-200 file:mr-3 file:rounded-md file:border-0 file:bg-slate-700 file:px-3 file:py-1.5 file:text-sm file:font-semibold file:text-white hover:file:bg-slate-600"
          (change)="onFileSelected($event)"
        />
      } @else {
        <input #fileInput type="file" accept="video/*" class="hidden" (change)="onFileSelected($event)" />
        <button type="button" class="btn-secondary" (click)="onChangeVideoClick()">Changer de vidéo</button>
      }

      <button
        type="button"
        class="btn-primary flex items-center justify-center"
        (click)="videoService.togglePlayPause()"
        [disabled]="!hasVideo()"
        [attr.aria-label]="videoService.isPlaying() ? 'Stop' : 'Play'"
      >
        <span class="text-base">{{ videoService.isPlaying() ? '■' : '▶' }}</span>
      </button>

      <button
        type="button"
        class="btn-secondary flex items-center justify-center"
        (click)="videoService.stepFrames(-1)"
        [disabled]="!hasVideo()"
        aria-label="Step frame arrière"
      >
        ◀
      </button>
      <button
        type="button"
        class="btn-secondary flex items-center justify-center"
        (click)="videoService.stepFrames(1)"
        [disabled]="!hasVideo()"
        aria-label="Step frame avant"
      >
        ▶
      </button>

      <div class="flex items-center gap-2 text-xs text-slate-300">
        <span>Vitesse</span>
        <span class="font-semibold text-slate-100">x{{ videoService.playbackRate() }}</span>
        <div class="flex flex-col">
          <button
            type="button"
            class="btn-secondary px-2 py-0.5 text-xs leading-none"
            (click)="increaseRate()"
            [disabled]="!hasVideo()"
            aria-label="Augmenter la vitesse"
          >
            +
          </button>
          <button
            type="button"
            class="btn-secondary px-2 py-0.5 text-xs leading-none"
            (click)="decreaseRate()"
            [disabled]="!hasVideo()"
            aria-label="Diminuer la vitesse"
          >
            -
          </button>
        </div>
      </div>
      </div>
    </div>
  </div>
</section>
